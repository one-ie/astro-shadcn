# Convex + Better Auth Setup - Next Steps

## âœ… What's Been Completed

All code files have been created and configured. Your project now has:

### 1. **Packages Installed**
- âœ… `better-auth@1.3.23`
- âœ… `@daveyplate/better-auth-ui@3.2.5`
- âœ… `@convex-dev/better-auth@0.8.6`
- âœ… `convex@1.27.3`
- âœ… `@astrojs/node@9.4.4`

### 2. **Astro Configuration**
- âœ… Changed from static to SSR mode (`output: 'server'`)
- âœ… Added Node.js adapter

### 3. **Convex Files**
- âœ… `convex.config.ts` - Convex app config with Better Auth component
- âœ… `convex/auth.config.ts` - Auth provider configuration
- âœ… `convex/auth.ts` - Better Auth server instance with GitHub & Google OAuth
- âœ… `convex/http.ts` - HTTP router for auth endpoints

### 4. **Frontend Files**
- âœ… `src/lib/auth-client.ts` - Client-side auth instance
- âœ… `src/components/ConvexClientProvider.tsx` - Convex provider
- âœ… `src/components/AuthProviders.tsx` - Auth UI provider
- âœ… `src/components/UserButton.tsx` - User authentication button
- âœ… `src/middleware.ts` - Authentication middleware
- âœ… `src/env.d.ts` - TypeScript types for Astro.locals

### 5. **Pages & Routes**
- âœ… `src/pages/api/auth/[...all].ts` - Auth API proxy
- âœ… `src/pages/auth/[pathname].astro` - Dynamic auth pages (sign-in, sign-up, etc.)
- âœ… `src/pages/dashboard.astro` - Protected dashboard example
- âœ… `src/pages/settings.astro` - Account settings page

### 6. **Layout Updates**
- âœ… `src/layouts/Layout.astro` - Wrapped with Convex and Auth providers
- âœ… `src/styles/global.css` - Added Better Auth UI styles

---

## ðŸš€ Required Steps to Complete Setup

### Step 1: Initialize Convex

Run this command in a **separate terminal** (keep your dev server running):

```bash
npx convex dev
```

This will:
1. Prompt you to create a Convex account or log in
2. Create a new Convex project or select an existing one
3. Generate `.env.local` with `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL`
4. Start the Convex dev server (keep it running)
5. Generate TypeScript types in `convex/_generated/`

**Important:** Keep `npx convex dev` running in a separate terminal window.

### Step 2: Set Up OAuth Providers

#### GitHub OAuth App

1. Go to: https://github.com/settings/developers
2. Click "New OAuth App"
3. Fill in:
   - **Application name**: Your app name
   - **Homepage URL**: `http://localhost:4322` (your current dev server)
   - **Callback URL**: `http://localhost:4322/api/auth/callback/github`
4. Click "Register application"
5. Click "Generate a new client secret"
6. **Save both Client ID and Client Secret**

#### Google OAuth Credentials

1. Go to: https://console.cloud.google.com/
2. Create or select a project
3. **Configure OAuth consent screen** (required first):
   - Go to: APIs & Services â†’ OAuth consent screen
   - Select "External" user type
   - Fill in app name, user support email, developer email
   - Add scopes: `openid`, `email`, `profile`
   - Add test users (for development)
4. **Create credentials**:
   - Go to: APIs & Services â†’ Credentials
   - Click "Create Credentials" â†’ "OAuth client ID"
   - Application type: "Web application"
   - **Authorized redirect URIs**: `http://localhost:4322/api/auth/callback/google`
   - Click "Create"
   - **Save Client ID and Client Secret**

### Step 3: Configure Environment Variables

After `npx convex dev` creates your `.env.local`, you need to set Convex environment variables:

```bash
# Generate and set Better Auth secret
npx convex env set BETTER_AUTH_SECRET $(openssl rand -base64 32)

# Set your site URL (use your actual dev server port)
npx convex env set SITE_URL http://localhost:4322

# Add GitHub OAuth credentials
npx convex env set GITHUB_CLIENT_ID your_github_client_id_here
npx convex env set GITHUB_CLIENT_SECRET your_github_client_secret_here

# Add Google OAuth credentials
npx convex env set GOOGLE_CLIENT_ID your_google_client_id_here
npx convex env set GOOGLE_CLIENT_SECRET your_google_client_secret_here
```

### Step 4: Verify Your Setup

After completing the above steps, test your authentication:

1. **Sign Up Page**: http://localhost:4322/auth/sign-up
2. **Sign In Page**: http://localhost:4322/auth/sign-in
3. **Protected Dashboard**: http://localhost:4322/dashboard
4. **Account Settings**: http://localhost:4322/settings

---

## ðŸ“‹ Environment Variables Checklist

### In `.env.local` (auto-generated by Convex)
- [ ] `CONVEX_DEPLOYMENT=dev:adjective-animal-123`
- [ ] `NEXT_PUBLIC_CONVEX_URL=https://adjective-animal-123.convex.cloud`

### In Convex Environment (set via `npx convex env set`)
- [ ] `BETTER_AUTH_SECRET` (generated with openssl)
- [ ] `SITE_URL` (your dev server URL)
- [ ] `GITHUB_CLIENT_ID`
- [ ] `GITHUB_CLIENT_SECRET`
- [ ] `GOOGLE_CLIENT_ID`
- [ ] `GOOGLE_CLIENT_SECRET`

---

## ðŸ§ª Testing Your Authentication Flow

### Test Email/Password Signup
1. Navigate to `http://localhost:4322/auth/sign-up`
2. Fill in name, email, and password
3. Click "Sign Up"
4. You should be signed in automatically
5. Check Convex dashboard to see the user record

### Test GitHub OAuth
1. Navigate to `http://localhost:4322/auth/sign-in`
2. Click "Sign in with GitHub"
3. Authorize the application
4. You'll be redirected back and signed in

### Test Google OAuth
1. Navigate to `http://localhost:4322/auth/sign-in`
2. Click "Sign in with Google"
3. Select your Google account
4. Authorize the application
5. You'll be redirected back and signed in

### Test Protected Routes
1. Sign out if signed in
2. Try to access `http://localhost:4322/dashboard`
3. You should be redirected to sign-in
4. Sign in and you'll be redirected to dashboard

---

## ðŸŽ¨ Available Auth Routes

Your app now has these auth pages:

- `/auth/sign-in` - Sign in page
- `/auth/sign-up` - Sign up page
- `/auth/forgot-password` - Password reset request
- `/auth/reset-password` - Password reset confirmation
- `/dashboard` - Example protected page
- `/settings` - Account settings with avatar, password, 2FA, etc.

---

## ðŸ”§ Troubleshooting

### Issue: TypeScript Errors in Convex Files

**Solution**: Make sure `npx convex dev` is running. It auto-generates types. Wait a few seconds after saving files.

### Issue: "Cannot find module 'convex/_generated/api'"

**Solution**: Run `npx convex dev` to generate the types.

### Issue: OAuth Callback 404 Errors

**Solution**: Verify your callback URLs match exactly:
- GitHub: `http://localhost:4322/api/auth/callback/github`
- Google: `http://localhost:4322/api/auth/callback/google`

### Issue: Middleware Not Working

**Solution**: Ensure `NEXT_PUBLIC_CONVEX_URL` or `PUBLIC_CONVEX_URL` is set in `.env.local`

### Issue: Session Not Persisting

**Solution**: Check that cookies are being set. In development, ensure you're using `http://localhost` (not `127.0.0.1`)

---

## ðŸ“¦ Production Deployment

When you're ready to deploy:

1. Deploy Convex functions:
   ```bash
   npx convex deploy
   ```

2. Set production environment variables:
   ```bash
   npx convex env set BETTER_AUTH_SECRET $(openssl rand -base64 32) --prod
   npx convex env set SITE_URL https://yourdomain.com --prod
   npx convex env set GITHUB_CLIENT_ID your_prod_github_id --prod
   npx convex env set GITHUB_CLIENT_SECRET your_prod_github_secret --prod
   npx convex env set GOOGLE_CLIENT_ID your_prod_google_id --prod
   npx convex env set GOOGLE_CLIENT_SECRET your_prod_google_secret --prod
   ```

3. Create separate production OAuth apps with production callback URLs

4. Deploy your Astro app to your hosting provider

---

## ðŸ“š Next Steps

After authentication is working, consider adding:

- **Email Verification**: Enable in `convex/auth.ts`
- **Two-Factor Authentication**: Already configured, users can enable in settings
- **Magic Link Authentication**: Passwordless login via email
- **Passkeys/WebAuthn**: Biometric authentication
- **Rate Limiting**: Protect auth endpoints from brute force
- **Custom User Fields**: Add additional profile fields

---

## ðŸŽ‰ You're Almost Done!

All the code is ready. Just run:

1. `npx convex dev` (in a separate terminal)
2. Set up OAuth apps (GitHub & Google)
3. Configure environment variables
4. Test authentication flows

Then you'll have a production-ready auth system! ðŸš€
